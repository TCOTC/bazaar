name: PR Check

# REF https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target
on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main
    paths:
      - icons.json
      - plugins.json
      - templates.json
      - themes.json
      - widgets.json

jobs:
  check:
    if: ${{ github.repository_owner == 'siyuan-note' }}
    runs-on: ubuntu-latest
    env:
      PAT: ${{ secrets.PAT }}
      PR_REPO_PATH: ./pr-repo
      BASE_REPO_PATH: ./base-repo
      MAIN_REPO_PATH: ./main-repo
      FILE_PATH_CHECK_RESULT_OUTPUT: ./templates/check-result.md
    steps:
      - name: Check out current repo
        uses: actions/checkout@v6

      # REF https://github.com/marketplace/actions/checkout#checkout-multiple-repos-nested
      # REF https://github.com/marketplace/actions/checkout#checkout-pull-request-head-commit-instead-of-merge-commit
      - name: Check out PR repo
        uses: actions/checkout@v6
        with:
          path: ${{ env.PR_REPO_PATH }}
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ env.PAT }}

      # Check out base branch to compare with PR branch
      # 使用 PR 的 base commit（PR 创建时的 base），这样可以准确识别 PR 相对于其 base 的变更
      # 无论 PR 是否有冲突，都能正确识别 PR 真正添加/删除的内容
      - name: Check out base branch (PR base commit)
        uses: actions/checkout@v6
        with:
          path: ${{ env.BASE_REPO_PATH }}
          ref: ${{ github.event.pull_request.base.sha }}
          repository: ${{ github.repository }}
          token: ${{ env.PAT }}

      # Check out main branch (latest state) for filtering
      # 用于过滤掉那些已经在 main 中存在的仓库（可能是解决冲突时合并过来的）
      - name: Check out main branch (latest)
        uses: actions/checkout@v6
        with:
          path: ${{ env.MAIN_REPO_PATH }}
          ref: main
          repository: ${{ github.repository }}
          token: ${{ env.PAT }}

      - name: Setup Golang
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Go Check
        run: go run ./actions/check

      # REF https://github.com/marketplace/actions/comment-pull-request
      - name: Comment PR with check-result
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: ${{ env.FILE_PATH_CHECK_RESULT_OUTPUT }}
          comment_tag: check-result
